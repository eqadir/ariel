<!--
Copyright 2024 Google LLC

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<mat-toolbar color="secondary">
  <span>Ariel - AI Video Ad Dubbing</span>
</mat-toolbar>
<br />
<div class="content">
  <mat-stepper orientation="vertical" [linear]="isLinear" #stepper>
    <mat-step [stepControl]="configFormGroup">
      <form [formGroup]="configFormGroup">
        <ng-template matStepLabel>Select video to dub</ng-template>
        <mat-label for="file">Input Video</mat-label>
        <input
          type="file"
          #videoInput
          accept="video/*"
          formControlName="input_video"
          (change)="onFileSelected($event)"
          required
        />
        @if (selectedFile && selectedFileUrl !== '') {
          <video [src]="selectedFileUrl" height="300" controls></video>
        }
        <div>
          <button mat-button matStepperNext type="button">Next</button>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="configFormGroup">
      <form [formGroup]="configFormGroup">
        <ng-template matStepLabel>Dubber settings</ng-template>
        <mat-form-field class="full-width">
          <mat-label>Hugging Face API token</mat-label>
          <input
            matInput
            placeholder="Generate a token at HuggingFace"
            formControlName="hugging_face_token"
            autocomplete="on"
            required
          />
        </mat-form-field>
        <mat-form-field class="full-width">
          <mat-label>Advertiser name</mat-label>
          <input
            matInput
            placeholder="Name of the advertiser."
            formControlName="advertiser_name"
            required
          />
        </mat-form-field>
        <mat-form-field class="full-width">
          <mat-label>Original Language</mat-label>
          <select matNativeControl formControlName="original_language" required>
            <option value="ar-SA">Arabic (SA)</option>
            <option value="ar-EG">Arabic (EG)</option>
            <option value="bn-BD">Bengali (BD)</option>
            <option value="bn-IN">Bengali (IN)</option>
            <option value="bg-BG">Bulgarian (BG)</option>
            <option value="zh-CN">Chinese (Simplified) (CN)</option>
            <option value="zh-TW">Chinese (Traditional) (TW)</option>
            <option value="hr-HR">Croatian (HR)</option>
            <option value="cs-CZ">Czech (CZ)</option>
            <option value="da-DK">Danish (DK)</option>
            <option value="nl-NL">Dutch (NL)</option>
            <option value="en-US" selected>English (US)</option>
            <option value="en-GB">English (GB)</option>
            <option value="en-CA">English (CA)</option>
            <option value="en-AU">English (AU)</option>
            <option value="et-EE">Estonian (EE)</option>
            <option value="fi-FI">Finnish (FI)</option>
            <option value="fr-FR">French (FR)</option>
            <option value="fr-CA">French (CA)</option>
            <option value="de-DE">German (DE)</option>
            <option value="el-GR">Greek (GR)</option>
            <option value="gu-IN">Gujarati (IN)</option>
            <option value="he-IL">Hebrew (IL)</option>
            <option value="hi-IN">Hindi (IN)</option>
            <option value="hu-HU">Hungarian (HU)</option>
            <option value="id-ID">Indonesian (ID)</option>
            <option value="it-IT">Italian (IT)</option>
            <option value="ja-JP">Japanese (JP)</option>
            <option value="kn-IN">Kannada (IN)</option>
            <option value="ko-KR">Korean (KR)</option>
            <option value="lv-LV">Latvian (LV)</option>
            <option value="lt-LT">Lithuanian (LT)</option>
            <option value="ml-IN">Malayalam (IN)</option>
            <option value="mr-IN">Marathi (IN)</option>
            <option value="nb-NO">Norwegian (NB-NO)</option>
            <option value="nn-NO">Norwegian (NN-NO)</option>
            <option value="pl-PL">Polish (PL)</option>
            <option value="pt-PT">Portuguese (PT)</option>
            <option value="pt-BR">Portuguese (BR)</option>
            <option value="ro-RO">Romanian (RO)</option>
            <option value="ru-RU">Russian (RU)</option>
            <option value="sr-RS">Serbian (RS)</option>
            <option value="sk-SK">Slovak (SK)</option>
            <option value="sl-SI">Slovenian (SI)</option>
            <option value="es-ES">Spanish (ES)</option>
            <option value="es-MX">Spanish (MX)</option>
            <option value="sw-KE">Swahili (KE)</option>
            <option value="sv-SE">Swedish (SE)</option>
            <option value="ta-IN">Tamil (IN)</option>
            <option value="ta-LK">Tamil (LK)</option>
            <option value="te-IN">Telugu (IN)</option>
            <option value="th-TH">Thai (TH)</option>
            <option value="tr-TR">Turkish (TR)</option>
            <option value="uk-UA">Ukrainian (UA)</option>
            <option value="vi-VN">Vietnamese (VN)</option>
          </select>
        </mat-form-field>
        <mat-form-field class="full-width">
          <mat-label>Target Language</mat-label>
          <select matNativeControl formControlName="target_language" required>
            <option value="ar-SA">Arabic (SA)</option>
            <option value="ar-EG">Arabic (EG)</option>
            <option value="bn-BD">Bengali (BD)</option>
            <option value="bn-IN">Bengali (IN)</option>
            <option value="bg-BG">Bulgarian (BG)</option>
            <option value="zh-CN">Chinese (Simplified) (CN)</option>
            <option value="zh-TW">Chinese (Traditional) (TW)</option>
            <option value="hr-HR">Croatian (HR)</option>
            <option value="cs-CZ">Czech (CZ)</option>
            <option value="da-DK">Danish (DK)</option>
            <option value="nl-NL">Dutch (NL)</option>
            <option value="en-US">English (US)</option>
            <option value="en-GB">English (GB)</option>
            <option value="en-CA">English (CA)</option>
            <option value="en-AU">English (AU)</option>
            <option value="et-EE">Estonian (EE)</option>
            <option value="fi-FI">Finnish (FI)</option>
            <option value="fr-FR">French (FR)</option>
            <option value="fr-CA">French (CA)</option>
            <option value="de-DE" selected>German (DE)</option>
            <option value="el-GR">Greek (GR)</option>
            <option value="gu-IN">Gujarati (IN)</option>
            <option value="he-IL">Hebrew (IL)</option>
            <option value="hi-IN">Hindi (IN)</option>
            <option value="hu-HU">Hungarian (HU)</option>
            <option value="id-ID">Indonesian (ID)</option>
            <option value="it-IT">Italian (IT)</option>
            <option value="ja-JP">Japanese (JP)</option>
            <option value="kn-IN">Kannada (IN)</option>
            <option value="ko-KR">Korean (KR)</option>
            <option value="lv-LV">Latvian (LV)</option>
            <option value="lt-LT">Lithuanian (LT)</option>
            <option value="ml-IN">Malayalam (IN)</option>
            <option value="mr-IN">Marathi (IN)</option>
            <option value="nb-NO">Norwegian (NB-NO)</option>
            <option value="nn-NO">Norwegian (NN-NO)</option>
            <option value="pl-PL">Polish (PL)</option>
            <option value="pt-PT">Portuguese (PT)</option>
            <option value="pt-BR">Portuguese (BR)</option>
            <option value="ro-RO">Romanian (RO)</option>
            <option value="ru-RU">Russian (RU)</option>
            <option value="sr-RS">Serbian (RS)</option>
            <option value="sk-SK">Slovak (SK)</option>
            <option value="sl-SI">Slovenian (SI)</option>
            <option value="es-ES">Spanish (ES)</option>
            <option value="es-MX">Spanish (MX)</option>
            <option value="sw-KE">Swahili (KE)</option>
            <option value="sv-SE">Swedish (SE)</option>
            <option value="ta-IN">Tamil (IN)</option>
            <option value="ta-LK">Tamil (LK)</option>
            <option value="te-IN">Telugu (IN)</option>
            <option value="th-TH">Thai (TH)</option>
            <option value="tr-TR">Turkish (TR)</option>
            <option value="uk-UA">Ukrainian (UA)</option>
            <option value="vi-VN">Vietnamese (VN)</option>
          </select>
        </mat-form-field>
        <br />
        <br />
        <span style="font-weight: bold">Advanced settings</span>
        <br />
        <br />
        <mat-accordion>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>Voice</mat-panel-title>
            </mat-expansion-panel-header>
            <div class="slider-label-container full-width">
              <label id="num-speakers-slider-label"
                >Number of speakers in the ad
              </label>
              <label class="slider-value-label">{{
                numSpeakersSlider.value
              }}</label>
            </div>
            <mat-slider min="0" max="5" step="1" class="full-width">
              <input
                matSliderThumb
                value="1"
                #numSpeakersSlider
                formControlName="number_of_speakers"
              />
            </mat-slider>
            <mat-form-field class="full-width">
              <mat-label>Assigned voices override</mat-label>
              <textarea
                matInput
                matTooltip="A mapping between unique speaker IDs and the full name of their assigned voices."
                placeholder="E.g. {'speaker_01':'en-US-Casual-K'} or {'speaker_01': 'Charlie'}"
                formControlName="assigned_voices_override"
                autocomplete="on"
              ></textarea>
            </mat-form-field>
            <mat-form-field class="full-width">
              <mat-label>Preferred voices</mat-label>
              <mat-chip-grid
                #preferredVoicesChipGrid
                aria-label="Enter preferred voices"
                formControlName="preferred_voices"
              >
                @for (voice of preferredVoices(); track voice) {
                  <mat-chip-row
                    (removed)="removeChipEntry(preferredVoices, voice)"
                  >
                    {{ voice }}
                    <button matChipRemove aria-label="'remove ' + voice">
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip-row>
                }
              </mat-chip-grid>
              <input
                placeholder="Add preferred voice.."
                [matChipInputFor]="preferredVoicesChipGrid"
                (matChipInputTokenEnd)="addChipEntry(preferredVoices, $event)"
              />
            </mat-form-field>
            <mat-form-field class="full-width">
              <mat-label>No dubbing phrases</mat-label>
              <mat-chip-grid
                #noDubbingPhrasesChipGrid
                aria-label="Enter phrase that should not be dubbed"
                matTooltip="Phrases to exclude in the dubbing process. The original utterance will be used instead."
                formControlName="no_dubbing_phrases"
              >
                @for (phrase of noDubbingPhrases(); track phrase) {
                  <mat-chip-row
                    (removed)="removeChipEntry(noDubbingPhrases, phrase)"
                  >
                    {{ phrase }}
                    <button matChipRemove aria-label="'remove ' + phrase">
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip-row>
                }
              </mat-chip-grid>
              <input
                placeholder="Add a phrase that should not be dubbed.."
                [matChipInputFor]="noDubbingPhrasesChipGrid"
                (matChipInputTokenEnd)="addChipEntry(noDubbingPhrases, $event)"
              />
            </mat-form-field>
            <mat-form-field class="full-width">
              <mat-label>Diarization Instructions</mat-label>
              <input
                matInput
                placeholder="Specific instructions for speaker diarization."
                formControlName="diarization_instructions"
              />
            </mat-form-field>
            <mat-form-field class="full-width">
              <mat-label>Translation Instructions</mat-label>
              <input
                matInput
                placeholder="Specific instructions for translation."
                formControlName="translation_instructions"
              />
            </mat-form-field>
            <mat-checkbox
              class="full-width"
              matTooltip="Merge utterances with timestamps closer than the threshold."
              formControlName="merge_utterances"
              >Merge utterances</mat-checkbox
            >
            <div class="slider-label-container full-width">
              <label id="num-speakers-slider-label"
                >Minimum merge threshold (seconds)
              </label>
              <label class="slider-value-label">{{
                minMergeThresholdSlider.value
              }}</label>
            </div>
            <mat-slider min="0.0" max="3.0" step="0.001" class="full-width">
              <input
                matSliderThumb
                value="0.001"
                formControlName="minimum_merge_threshold"
                #minMergeThresholdSlider
              />
            </mat-slider>
            <mat-checkbox
              class="full-width"
              matTooltip="Avoids repetitive voice assignment and cloning."
              formControlName="keep_voice_assignments"
              >Keep voice assignments</mat-checkbox
            >
            <mat-checkbox
              class="full-width"
              matTooltip="Adjust the duration of the dubbed audio files to match the duration of the source audio files."
              formControlName="adjust_speed"
              >Adjust speed</mat-checkbox
            >
            <div class="slider-label-container full-width">
              <label id="vocals-volume-slider-label"
                >Vocals volume adjustment
              </label>
              <label class="slider-value-label">{{
                vocalsVolumeAdjustmentSlider.value
              }}</label>
            </div>
            <mat-slider min="0.0" max="10.0" step="0.1" class="full-width">
              <input
                matSliderThumb
                value="5.0"
                formControlName="vocals_volume_adjustment"
                #vocalsVolumeAdjustmentSlider
              />
            </mat-slider>
            <div class="slider-label-container full-width">
              <label id="background-volume-slider-label"
                >Background volume adjustment
              </label>
              <label class="slider-value-label">{{
                backgroundVolumeAdjustmentSlider.value
              }}</label>
            </div>
            <mat-slider min="0.0" max="10.0" step="0.1" class="full-width">
              <input
                matSliderThumb
                value="0.0"
                formControlName="background_volume_adjustment"
                #backgroundVolumeAdjustmentSlider
              />
            </mat-slider>
          </mat-expansion-panel>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>Gemini</mat-panel-title>
            </mat-expansion-panel-header>
            <mat-form-field class="full-width">
              <mat-label>Gemini model</mat-label>
              <select matNativeControl formControlName="gemini_model_name">
                <option value="gemini-1.5-flash" selected>
                  gemini-1.5-flash
                </option>
                <option value="gemini-1.5-pro">gemini-1.5-pro</option>
              </select>
            </mat-form-field>
            <div class="slider-label-container full-width">
              <label id="gemini-temperature-slider-label">Temperature</label>
              <label class="slider-value-label">{{
                geminiTemperatureSlider.value
              }}</label>
            </div>
            <mat-slider min="0.0" max="2.0" step="0.1" class="full-width">
              <input
                matSliderThumb
                value="1.0"
                matTooltip="Randomness in token selection."
                formControlName="temperature"
                #geminiTemperatureSlider
              />
            </mat-slider>
            <div class="slider-label-container full-width">
              <label id="gemini-top-p-slider-label">Top P</label>
              <label class="slider-value-label">{{
                geminiTopPSlider.value
              }}</label>
            </div>
            <mat-slider min="0.0" max="1.0" step="0.01" class="full-width">
              <input
                matSliderThumb
                value="0.95"
                matTooltip="Top-p changes how the model selects tokens for output. Tokens are selected from most probable to least until the sum of their probabilities equals the top-p value. For example, if tokens A, B, and C have a probability of .3, .2, and .1 and the top-p value is .5, then the model will select either A or B as the next token (using temperature). For the least variable results, set top-P to 0."
                formControlName="top_p"
                #geminiTopPSlider
              />
            </mat-slider>
            <div class="slider-label-container full-width">
              <label id="gemini-top-k-slider-label">Top K</label>
              <label class="slider-value-label">{{
                geminiTopKSlider.value
              }}</label>
            </div>
            <mat-slider min="1" max="40" step="1" class="full-width">
              <input
                matSliderThumb
                value="40"
                matTooltip="Top-K specifies the number of candidate tokens when the model is selecting an output token. Use a lower value for less random responses and a higher value for more random responses."
                formControlName="top_k"
                #geminiTopKSlider
              />
            </mat-slider>
            <mat-form-field class="full-width">
              <mat-label>Gemini safety settings</mat-label>
              <select
                matNativeControl
                matTooltip="What kind of safety settings to use in the dubbing process."
                formControlName="safety_settings"
              >
                <option value="Low" selected>Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
                <option value="None">None</option>
              </select>
            </mat-form-field>
          </mat-expansion-panel>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>ElevenLabs</mat-panel-title>
            </mat-expansion-panel-header>
            <mat-checkbox
              class="full-width"
              matTooltip="use ElevenLabs API for the highest quality voiceover. WARNING: ElevenLabs API is a paid solution and will generate extra costs."
              formControlName="use_elevenlabs"
              >Use ElevenLabs</mat-checkbox
            >
            <mat-form-field class="full-width">
              <mat-label>ElevenLabs API token</mat-label>
              <input
                matInput
                placeholder="Get an API token at ElevenLabs"
                formControlName="elevenlabs_token"
                autocomplete="on"
              />
            </mat-form-field>
            <mat-checkbox
              class="full-width"
              matTooltip="Use ElevenLabs API to clone source voices. WARNING: This ElevenLabs API functionality might require higher tier pricing."
              formControlName="elevenlabs_clone_voices"
              >Clone voices</mat-checkbox
            >
            <mat-checkbox
              class="full-width"
              matTooltip="Remove all the voices that were cloned with ELevenLabs during the dubbing process."
              formControlName="elevenlabs_remove_cloned_voices"
              >Remove cloned voices</mat-checkbox
            >
          </mat-expansion-panel>
        </mat-accordion>
        <br />
        <div>
          <button mat-button matStepperPrevious>Back</button>
          <button mat-button matStepperNext (click)="generateUtterances()">
            Generate translations
          </button>
        </div>
      </form>
    </mat-step>
    <mat-step [stepControl]="translationsFormGroup">
      <ng-template matStepLabel>Review translations</ng-template>
      <div class="mat-expansion-panel-body">
        <div class="container">
          @if (loadingTranslations) {
            <mat-spinner></mat-spinner>
            This could take up to 5 minutes...
          } @else {
            <div class="row">
              <div class="col">
                <span style="font-weight: bold">Original language</span>
              </div>
              <div class="col">
                <span style="font-weight: bold">Translated language</span>
              </div>
            </div>
            @for (dubbing of dubbedInstances; track dubbing) {
              <div class="row">
                <div class="col">
                  <mat-card style="flex: 1">
                    <mat-card-header> </mat-card-header>
                    <mat-card-content>
                      <p>{{ dubbing.text }}</p>
                    </mat-card-content>
                  </mat-card>
                </div>
                <div class="col">
                  <mat-card>
                    <mat-card-content>
                      @if (!dubbing.editing) {
                        <div class="audio-container">
                          <mat-icon
                            (click)="playAudio(dubbing.dubbed_path)"
                            class="speaker-icon"
                            >volume_up</mat-icon
                          >
                        </div>
                        <div class="translated-text">
                          {{ dubbing.translated_text }}
                        </div>
                        <div>
                          <span class="label">Start:</span> {{ dubbing.start }}
                        </div>
                        <div>
                          <span class="label">End:</span> {{ dubbing.end }}
                        </div>
                        <div>
                          <span class="label">For Dubbing:</span>
                          {{ dubbing.for_dubbing }}
                        </div>
                        <div>
                          <span class="label">Speaker ID:</span>
                          {{ dubbing.speaker_id }}
                        </div>
                        <div>
                          <span class="label">SSML Gender:</span>
                          {{ dubbing.ssml_gender }}
                        </div>
                        <div>
                          <span class="label">Assigned Voice:</span>
                          {{ dubbing.assigned_voice }}
                        </div>
                        <div>
                          <span class="label">Pitch:</span> {{ dubbing.pitch }}
                        </div>
                        <div>
                          <span class="label">Speed:</span> {{ dubbing.speed }}
                        </div>
                        <div>
                          <span class="label">Volume Gain (dB):</span>
                          {{ dubbing.volume_gain_db }}
                        </div>
                        <div>
                          <span class="label">Adjust Speed:</span>
                          {{ dubbing.adjust_speed }}
                        </div>
                      } @else {
                        <mat-form-field class="full-width edit-textarea">
                          <mat-label>Translated text</mat-label>
                          <textarea
                            matInput
                            [(ngModel)]="dubbing.translated_text"
                          ></textarea>
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>Start</mat-label>
                          <input
                            matInput
                            type="number"
                            [(ngModel)]="dubbing.start"
                          />
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>End</mat-label>
                          <input
                            matInput
                            type="number"
                            [(ngModel)]="dubbing.end"
                          />
                        </mat-form-field>
                        <mat-checkbox [(ngModel)]="dubbing.for_dubbing"
                          >Use for dubbing</mat-checkbox
                        >
                        <mat-form-field class="full-width">
                          <mat-label>Speaker ID</mat-label>
                          <input matInput [(ngModel)]="dubbing.speaker_id" />
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>SSML Gender</mat-label>
                          <mat-select [(ngModel)]="dubbing.ssml_gender">
                            <mat-option value="male"> Male </mat-option>
                            <mat-option value="female">Female</mat-option>
                          </mat-select>
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>Assigned Voice</mat-label>
                          <input
                            matInput
                            [(ngModel)]="dubbing.assigned_voice"
                          />
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>Pitch</mat-label>
                          <input
                            matInput
                            type="number"
                            [(ngModel)]="dubbing.pitch"
                          />
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>Speed</mat-label>
                          <input
                            matInput
                            type="number"
                            [(ngModel)]="dubbing.speed"
                          />
                        </mat-form-field>
                        <mat-form-field class="full-width">
                          <mat-label>Volume Gain (dB)</mat-label>
                          <input
                            matInput
                            type="number"
                            [(ngModel)]="dubbing.volume_gain_db"
                          />
                        </mat-form-field>
                        <mat-checkbox [(ngModel)]="dubbing.adjust_speed"
                          >Adjust speed</mat-checkbox
                        >
                      }
                    </mat-card-content>
                    <mat-card-actions align="end">
                      <button mat-button (click)="toggleEdit(dubbing)">
                        {{ dubbing.editing ? 'Save' : 'Edit' }}
                      </button>
                    </mat-card-actions>
                  </mat-card>
                </div>
              </div>
            }
          }
        </div>
      </div>
      <div>
        <button mat-button matStepperPrevious>Back</button>
        <button mat-button matStepperNext (click)="dubVideo()">
          Dub video
        </button>
      </div>
    </mat-step>
    <mat-step>
      <ng-template matStepLabel>Download videos</ng-template>
      @if (loadingDubbedVideo) {
        <mat-spinner></mat-spinner>
        This could take up to 5 minutes...
      }
      @if (dubbingCompleted && dubbedUrl !== '') {
        <p>Video generation is completed.</p>
        <video [src]="dubbedUrl" height="300" controls></video>
        <a mat-button href="{{ dubbedUrl }}" download="dubbed_video.mp4"
          >Download video</a
        >
      }
      <div>
        <button mat-button matStepperPrevious>Back</button>
        <button mat-button (click)="stepper.reset()">Dub another video</button>
      </div>
    </mat-step>
  </mat-stepper>
</div>
